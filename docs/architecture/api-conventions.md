# Tracelify — API Conventions

Standards for all HTTP endpoints in the Tracelify API. These apply from MVP onward.

## Versioning

All endpoints are prefixed with `/v1`. This is applied at the router level in `app.py`, not repeated in each router file.

```
POST   /v1/documents
GET    /v1/documents
DELETE /v1/documents/{doc_id}
POST   /v1/chat
GET    /v1/health
```

**Why version from day one:** Tracelify is API-first — external clients (CLI tools, the web UI, integrations) depend on endpoint contracts. Adding `/v1` later is a breaking change for every client. Starting with it costs nothing.

**Version bump rules:**
- Removing an endpoint or field → new major version (`/v2`)
- Renaming an endpoint or field → new major version
- Adding an optional field to a response → no version bump
- Adding a new endpoint → no version bump
- When `/v2` is introduced, `/v1` remains available for at least 6 months

## Error Response Schema

All errors return the same JSON shape, regardless of status code.

```json
{
  "error": {
    "code": "document_not_found",
    "message": "No document found with ID 'my-doc'",
    "request_id": "req_abc123def456"
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `error.code` | `string` | Machine-readable error code. Lowercase, snake_case. Clients switch on this. |
| `error.message` | `string` | Human-readable description. Not stable — don't parse it. |
| `error.request_id` | `string` | Same request ID from the response header. Included for convenience. |

### Error Codes

Error codes are namespaced by feature:

| HTTP Status | Code | When |
|-------------|------|------|
| 400 | `invalid_file_type` | Upload is not `.txt` or `.md` |
| 400 | `invalid_request` | Generic malformed request |
| 401 | `unauthorized` | Missing or invalid auth token |
| 403 | `forbidden` | Valid token but insufficient permissions |
| 404 | `document_not_found` | Document ID doesn't exist |
| 409 | `document_exists` | Document with same filename already ingested |
| 413 | `file_too_large` | Upload exceeds 10 MB |
| 422 | `validation_error` | Pydantic validation failed (auto-generated by FastAPI) |
| 429 | `rate_limited` | Too many requests (Phase 2) |
| 500 | `internal_error` | Unexpected server error. No internals exposed. |

### Implementation

Errors are raised via a custom exception and handled by a global exception handler, replacing FastAPI's default `{"detail": ...}` format.

```python
class APIError(Exception):
    def __init__(self, status_code: int, code: str, message: str):
        self.status_code = status_code
        self.code = code
        self.message = message

# Usage
raise APIError(404, "document_not_found", f"No document found with ID '{doc_id}'")
```

## Request IDs

Every request gets a unique ID, returned in the response headers and included in error bodies.

**Header:** `X-Request-ID`

**Format:** `req_` prefix + 12 random alphanumeric characters. Example: `req_a1b2c3d4e5f6`

**Behavior:**
- If the client sends an `X-Request-ID` header, the server uses it (pass-through). This allows tracing a request across multiple services.
- If the client doesn't send one, the server generates it.
- The request ID is included in all server-side log entries for that request.
- The request ID is returned in the response header and in error response bodies.

**Implementation:** FastAPI middleware that runs before routing.

```
Request:  POST /v1/documents
          X-Request-ID: req_client123

Response: 201 Created
          X-Request-ID: req_client123

---

Request:  POST /v1/documents
          (no X-Request-ID header)

Response: 201 Created
          X-Request-ID: req_a1b2c3d4e5f6
```

## Pagination

List endpoints return paginated results using cursor-based pagination.

### Response Shape

```json
{
  "items": [...],
  "pagination": {
    "next_cursor": "eyJpZCI6IDQyfQ",
    "has_more": true
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `items` | `array` | The page of results |
| `pagination.next_cursor` | `string \| null` | Opaque cursor for the next page. `null` if no more results. |
| `pagination.has_more` | `bool` | Whether more results exist beyond this page |

### Query Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `limit` | `int` | 20 | Items per page. Max 100. |
| `cursor` | `string` | (none) | Cursor from a previous response's `pagination.next_cursor` |

### Example

```
GET /v1/documents?limit=10
→ { "items": [...10 docs...], "pagination": { "next_cursor": "eyJpZCI6IDEwfQ", "has_more": true } }

GET /v1/documents?limit=10&cursor=eyJpZCI6IDEwfQ
→ { "items": [...next 10 docs...], "pagination": { "next_cursor": null, "has_more": false } }
```

**Why cursor-based, not offset-based:** Offset pagination breaks when items are inserted or deleted between pages (rows shift, causing duplicates or skips). Cursor pagination is stable — each page starts exactly where the last one ended. The cursor is an opaque base64-encoded value so clients can't construct or modify it.

**MVP exception:** The MVP has a small document set. Pagination is defined in the contract from the start but the MVP implementation can return all results in a single page with `has_more: false`. The schema is in place so clients don't need to change when real pagination is added.

## Authentication (Placeholder)

Authentication is not enforced in the MVP (single-user, local-first). The conventions below are defined now so the API contract is stable when auth is added in Phase 2.

**Scheme:** Bearer token in the `Authorization` header.

```
Authorization: Bearer tra_abc123...
```

**Token format:** `tra_` prefix (for "Tracelify") + opaque token string. The prefix makes tokens greppable in logs and distinguishable from other services' tokens.

**Behavior by phase:**

| Phase | Behavior |
|-------|----------|
| MVP | `Authorization` header is accepted but ignored. All requests are allowed. |
| Phase 2 | API key authentication. `tra_` tokens issued per user. Missing/invalid token → `401`. |
| Phase 3 | Role-based access. Valid token but wrong role → `403`. SSO tokens supported. |

**Public endpoints** (never require auth, even in Phase 2+):
- `GET /v1/health`

## Content Type

- All request and response bodies are `application/json`, except file uploads which use `multipart/form-data`.
- The API does not support XML, YAML, or other content types.

## Naming Conventions

| Element | Convention | Example |
|---------|-----------|---------|
| URL paths | lowercase, plural nouns, hyphens for multi-word | `/v1/documents`, `/v1/chat` |
| Path parameters | snake_case | `{doc_id}`, `{session_id}` |
| Query parameters | snake_case | `?chunk_size=500&limit=10` |
| JSON fields | snake_case | `doc_id`, `chunk_index`, `created_at` |
| Error codes | snake_case | `document_not_found` |
| Timestamps | ISO 8601 UTC | `2026-02-06T14:30:00Z` |
